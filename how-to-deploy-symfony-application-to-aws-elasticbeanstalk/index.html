
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>How-to: Deploy Symfony Application to AWS ElasticBeanstalk - ifdattic</title>
  <meta name="author" content="Andrew MarcinkeviÄius">

  
  <meta name="description" content="I while ago I started working on an application so I could learn Symfony and solve a problem I had. After it reached a minimal state where it could &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ifdattic.com/how-to-deploy-symfony-application-to-aws-elasticbeanstalk">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="ifdattic" type="application/atom+xml">
  <script src="/js/modernizr-2.8.3-custom.min.js"></script>
  <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./js/libs/jquery-2.1.3.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="https://plus.google.com/111660522645911622239/posts" rel="author">
<script src="//load.sumome.com/" data-sumo-site-id="c164debf0a268ada6ab9186c859e0f9e07ed6d194f1e9f7d9d80d283225e676e" async></script>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48134144-1', 'ifdattic.com');
    ga('send', 'pageview');

    window.onscroll = function () {
        window.onscroll = null;
        ga('send', 'event', 'ga bounce scroll');
    }

  </script>


</head>

<body >
  <header role="banner">
    <div class="wrapper"><hgroup>
  <h1>
    <a href="/">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="sitelogo" alt="ifdattic" />
    </a>
  </h1>
</hgroup>

<nav class="nav" data-state="closed">
  <a href="#" class="nav-reveal">
    <span></span>
    <span></span>
    <span></span>
  </a>
  <ul>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/">About</a></li>
  </ul>
</nav>


</div>
  </header>
  <div id="main">
    <div id="content" class="wrapper">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How-to: Deploy Symfony Application to AWS ElasticBeanstalk</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-19T08:03:02+02:00" pubdate data-updated="true">September 19, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I while ago I started working on an application so I could learn Symfony and solve a problem I had. After it reached a minimal state where it could be deployed to &ldquo;production&rdquo; environment I chose to push it to AWS ElasticBeanstalk as I&rsquo;m quite comfortable with using it. Unfortunately (or maybe fortunately as the best way to learn something is still through practice), I bumped into a few problems while deploying. The article is split into sections explaining what and why a piece of code is added. You might not need all of them or you might need some adjustments. For this article I will use the default Symfony application and full code can be found at <a href="https://github.com/ifdattic/symfony-app-deploy-to-aws-eb-article-code">github</a>.</p>

<blockquote><p>I&rsquo;m doing research on this topic and would appreciate if you would like to fill some questions at <a href="http://goo.gl/forms/cmEu5sio7G" data-ga-event="eb,click,top" target="_blank">Google Forms</a>. It&rsquo;s fine if you don&rsquo;t want to answer any of them or only answer one, every bit helps. Thank you for your time and enjoy the article.</p></blockquote>

<p>You can jump to any of the sections:</p>

<ul>
<li><a href="#update-20141003">Update on 2014-10-03</a></li>
<li><a href="#update-20141108">Update on 2014-11-08</a></li>
<li><a href="#update-20141207">Update on 2014-12-07</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#add-awsdevtools">Add AWSDevTools to Repository</a></li>
<li><a href="#create-key-pair">Create a Key Pair (optional)</a></li>
<li><a href="#create-eb-config">Create ElasticBeanstalk environment configuration/description</a></li>
<li><a href="#add-environment-variables">Add environment variables</a></li>
<li><a href="#add-vendors-dir">Add vendors Directory to Repository</a></li>
<li><a href="#add-environment-config">Add environment configuration and Update Composer</a></li>
<li><a href="#install-mongo-extension">Install mongo extension</a></li>
<li><a href="#run-composer-install">Run Composer Install</a></li>
<li><a href="#update-cache-files">Update Cache Files</a></li>
<li><a href="#add-apache-config">Add Apache Configuration (optional)</a></li>
<li><a href="#remove-dev-entry">Remove dev Entry Point (optional)</a></li>
<li><a href="#add-cron">Add Cron (optional)</a></li>
<li><a href="#add-new-relic-config">Add New Relic Configuration (optional)</a></li>
<li><a href="#install-nodejs">Install nodejs With Front-End Tools (2014-10-03)</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>


<h2>Update on 2014-10-03 <a name="update-20141003"></a></h2>

<p>Thanks to the <a href="http://ifdattic.com/how-to-deploy-symfony-application-to-aws-elasticbeanstalk/#comment-1604895694">tip from Philipp Rieber</a> the code can be simplified by removing the environment in console applications. If your environment has <code>SYMFONY_ENV</code> and <code>SYMFONY_DEBUG</code> set, they will be automatically retrieved by console script. This will allow to remove <code>--env</code> and <code>--no-debug</code> from console commands. This will also allow you to leave scripts in <code>composer.json</code> as the correct environment will be chosen.</p>

<h2>Update on 2014-11-08 <a name="update-20141108"></a></h2>

<p>Thanks to the tip from Nicolae Darie the <code>update-cache.sh</code> script was improved to replace all occurrences of <code>ondeck</code> in <a href="#update-cache-files">cache files</a>.</p>

<h2>Update on 2014-12-07 <a name="update-20141207"></a></h2>

<p>Thanks to the tip from Sergio Marchesini the <a href="#update-cache-files">Update Cache Files</a> section is not needed anymore if you&rsquo;re using at least Symfony 2.6.1.</p>

<h2>Prerequisites <a name="prerequisites"></a></h2>

<p>The article assumes you already have the <a href="http://aws.amazon.com">AWS account</a>, <a href="http://aws.amazon.com/cli">AWS CLI</a> configured and a project in <a href="https://github.com/ifdattic/symfony-app-deploy-to-aws-eb-article-code">git repository</a> ready to be deployed. The application will be deployed to <code>us-east-1</code> region, so make changes accordingly if you want to deploy to a different region.</p>

<p>For deployment we will use the <code>t2.micro</code> instance type, which is a new free tier eligible instance type. This updated instance type can only be launched in VPC so you might need to create it for your account, it can be done using a <a href="https://console.aws.amazon.com/vpc/home">wizard</a>.</p>

<p>If you will be creating a single instance ElasticBeanstalk application you only need <em>&ldquo;VPC with a Single Public Subnet.&rdquo;</em> If you want to create a load balanced application you will need <em>&ldquo;VPC with Public and Private Subnets.&rdquo;</em> Just note what VPC with public and private subnets requires a NAT instance which will add additional charges. You can learn more about creating VPC at <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo-vpc-basic.html">AWS Docs</a>.</p>

<p>You will also need to create the IAM role to be used for ElasticBeanstalk deployments.</p>

<p>Some of the steps can be done using the web GUI or different applications, but for the most part I will be using the terminal on OS X.</p>

<p>Check <strong><a href="https://github.com/ifdattic/symfony-app-deploy-to-aws-eb-article-code/tree/master/.ebextensions/misc">.ebextensions/misc/aws-cli-commands-used.md</a></strong> from demo application for more information (commands used).</p>

<h2>Add AWSDevTools to Repository <a name="add-awsdevtools"></a></h2>

<p>To be able to push your repository to the ElasticBeanstalk the repository has to be extended with <a href="http://aws.amazon.com/code/6752709412171743">AWSDevTools</a>. Download, extract and go to correct directory depending on your OS (for Linux and Mac it will be <code>AWSDevTools/Linux</code>). You need to run the <code>AWSDevTools-RepositorySetup.sh</code> from the directory which contains your repository.</p>

<p>If everything was done correctly you should get a few new commands under <code>git aws.</code> namespace. Now run the <code>git aws.config</code> command to initialize configuration required for pushing repository to ElasticBeanstalk (comments after <code>#</code>, don&rsquo;t enter them).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>AWS Region <span class="o">[</span>default to us-east-1<span class="o">]</span>: <span class="c"># enter your region</span>
</span><span class='line'>AWS Elastic Beanstalk Application: demo-app <span class="c"># enter your application name</span>
</span><span class='line'>AWS Elastic Beanstalk Environment: demo-prod-env <span class="c"># enter your environment name</span>
</span></code></pre></td></tr></table></div></figure>


<p>The command should output some explanations about how to set the AWS credentials. As I work with multiple AWS accounts I personally set the credentials in the project. The command created a <code>.elasticbeanstalk</code> directory which you should avoid adding to source control (especially if it contains credentials). The directory should have <code>config</code> and <code>aws_credential_file</code> files with contents (including a manual change for credentials):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="c1"># below is contents of .elasticbeanstalk/config</span>
</span><span class='line'>
</span><span class='line'><span class="k">[global]</span>
</span><span class='line'><span class="na">ApplicationName</span><span class="o">=</span><span class="s">demo-app</span>
</span><span class='line'><span class="na">DevToolsEndpoint</span><span class="o">=</span><span class="s">git.elasticbeanstalk.us-east-1.amazonaws.com</span>
</span><span class='line'><span class="na">EnvironmentName</span><span class="o">=</span><span class="s">demo-prod-env</span>
</span><span class='line'><span class="na">Region</span><span class="o">=</span><span class="s">us-east-1</span>
</span><span class='line'><span class="na">AwsCredentialFile</span><span class="o">=</span><span class="s">.elasticbeanstalk/aws_credential_file</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># below is contents of .elasticbeanstalk/aws_credential_file</span>
</span><span class='line'>
</span><span class='line'><span class="na">AWSAccessKeyId</span><span class="o">=</span><span class="s">your-access-key</span>
</span><span class='line'><span class="na">AWSSecretKey</span><span class="o">=</span><span class="s">your-secret-key</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Bonus tip:</strong> One of <a href="http://youtu.be/tTJrbsu_Wzc">best IAM practices</a> is to allow users only what they need. I use the separate group and user for pushing repository to ElasticBeanstalk. Bellow is the policy you can attach to your group/user to allow only what is needed for deploying an application (modify for your own needs):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;elasticbeanstalk:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;ec2:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;elasticloadbalancing:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;autoscaling:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;cloudwatch:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;s3:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;sns:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;cloudformation:*&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;rds:*&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Key Pair (optional) <a name="create-key-pair"></a></h2>

<p>If you want to connect to your instances (e.g., to debug) you will need a key pair. You should avoid making any changes to your instances as it won&rsquo;t persist and can bring your instance to unknown state.</p>

<p>You can create a key pair by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws ec2 create-key-pair --key-name demoapp_prodkey &gt; demoapp_prodkey.pem
</span></code></pre></td></tr></table></div></figure>


<p>After the command completes open the file, delete everything that is not inside <code>KeyMaterial</code> value and replace <code>\n</code> with newlines.</p>

<p>Before you start using the key pair you need to change the permissions which can be done with command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod 400 demoapp_prodkey.pem
</span></code></pre></td></tr></table></div></figure>


<p>To connect to your instance you will need to know the IP address of it. So for example if it was <code>54.88.29.72</code> you could SSH to it with the following command (to connect to Amazon Linux instances the user is <code>ec2-user</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ssh -i demoapp_prodkey.pem ec2-user@54.88.29.72
</span></code></pre></td></tr></table></div></figure>


<h2>Create ElasticBeanstalk environment configuration/description <a name="create-eb-config"></a></h2>

<p>To always get the ElasticBeanstalk environment in the same state all the required information should be saved inside configuration files.</p>

<p>Create a file <code>.ebextensions/env/prod-single.json</code> with the following contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;EnvironmentType&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleInstance&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:autoscaling:launchconfiguration&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;EC2KeyName&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;demoapp_prodkey&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:autoscaling:launchconfiguration&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;IamInstanceProfile&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;aws-elasticbeanstalk-ec2-role&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:autoscaling:launchconfiguration&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;InstanceType&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.micro&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:ec2:vpc&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;VPCId&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:ec2:vpc&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;Subnets&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:ec2:vpc&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;ELBSubnets&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:container:php:phpini&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;memory_limit&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;800M&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:container:php:phpini&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;document_root&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;/web&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:hostmanager&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;LogPublicationControl&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This configuration will create a single instance environment. For all available options and their explanations check the <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options.html">docs</a>. If you would like to create a load balanced environment you will need to make some changes to the configuration file (you can find it all at <code>.ebextensions/env/prod-load.json</code>). In short, you should remove <code>EnvironmentType</code> option (or change to <code>LoadBalanced</code>) and add the options provided below (just know what you will need a VPC with private and public subnets if you want to use new instance types):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:autoscaling:asg&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;MinSize&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:autoscaling:asg&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;MaxSize&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:autoscaling:launchconfiguration&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SecurityGroups&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will also need to fill values (will depend on application type, read <strong><a href="#prerequisites">Prerequisites</a></strong> and <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/AWSHowTo-vpc-basic.html">AWS VPC How To</a>) for <code>VPCId</code>, <code>Subnets</code>, <code>ELBSubnets</code>, <code>SecurityGroups</code> from your created VPC.</p>

<p>Run the following command to create your <code>demo-app</code> ElasticBeanstalk application (change the name or provide description if needed):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws elasticbeanstalk create-application --application-name demo-app --description <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you only need to choose the the solution stack name. All available stacks can be returned with command (we will choose the latest as of this writing 64 bit stack named <code>64bit Amazon Linux 2014.03 v1.0.4 running PHP 5.5</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws elasticbeanstalk list-available-solution-stacks
</span></code></pre></td></tr></table></div></figure>


<p>Run the command below to create the ElasticBeanstalk environment (configure the arguments if needed):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws elasticbeanstalk create-environment <span class="se">\</span>
</span><span class='line'>    --application-name demo-app <span class="se">\</span>
</span><span class='line'>    --environment-name demo-prod-env <span class="se">\</span>
</span><span class='line'>    --description <span class="s2">&quot;&quot;</span> <span class="se">\</span>
</span><span class='line'>    --option-settings file://.ebextensions/env/prod-single.json <span class="se">\</span>
</span><span class='line'>    --solution-stack-name <span class="s2">&quot;64bit Amazon Linux 2014.03 v1.0.4 running PHP 5.5&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After a while if everything was fine the new environment for application should be up and ready.</p>

<h2>Add environment variables <a name="add-environment-variables"></a></h2>

<p>Keeping credentials and other information (API keys, passwords, connection data, etc.) in source control is a bad idea and not really scalable. Your environment should contain all the information needed to make the application on it work. You can configure your environment variables using <code>aws:elasticbeanstalk:application:environment</code> namespace. Create the <code>.ebextensions/env/prod-variables.json</code> file and put the following into it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY_ENV&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;prod&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY_DEBUG&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__SECRET&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__MONGODB__SERVER&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__MONGODB__DATABASE&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__MONGODB__PASSWORD&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__MONGODB__USERNAME&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should fill the <code>Value</code> key with your values (just avoid committing the values to repository). The <code>SYMFONY_ENV</code> is the variable for describing the type of environment and will be used later. As the deployment should happen automatically and you won&rsquo;t be able to enter your parameters manually they should be set automatically using the environment variables. This can be done using variables which start with <code>SYMFONY__</code> as they are automatically converted (the <code>__</code> becomes a <code>.</code>). As an example the <code>SYMFONY__ENV__MONGODB__SERVER</code> will become <code>%env.mongodb.server%</code>. The <code>parameters.yml.dist</code> has to be updated for this to work, make sure it contains the following changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">secret</span><span class="p-Indicator">:</span>           <span class="s">&quot;%env.secret%&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">mongodb_server</span><span class="p-Indicator">:</span>   <span class="s">&quot;%env.mongodb.server%&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">mongodb_database</span><span class="p-Indicator">:</span> <span class="s">&quot;%env.mongodb.database%&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">mongodb_password</span><span class="p-Indicator">:</span> <span class="s">&quot;%env.mongodb.password%&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">mongodb_username</span><span class="p-Indicator">:</span> <span class="s">&quot;%env.mongodb.username%&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the following command to update your environment with variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws elasticbeanstalk update-environment <span class="se">\</span>
</span><span class='line'>    --environment-name demo-prod-env <span class="se">\</span>
</span><span class='line'>    --option-settings file://.ebextensions/env/prod-variables.json
</span></code></pre></td></tr></table></div></figure>


<h2>Add vendors Directory to Repository <a name="add-vendors-dir"></a></h2>

<p>The <code>10_composer_install.sh</code> hook on application deployment automatically runs <code>composer install</code> if it finds the <code>composer.json</code> file in the root directory. As I would like to run composer myself (and it might fail depending on your application) it can be disabled by moving <code>composer.json</code> file outside of main directory or by adding vendor directory to repository. This can be done by creating a <code>.gitkeep</code> file inside <code>vendor</code> directory and modifying <code>.gitignore</code> to contain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>/vendor/*
</span><span class='line'>!vendor/.gitkeep
</span></code></pre></td></tr></table></div></figure>


<p>This change will add a <code>vendor</code> directory to your repository, but everything inside it will be ignored (as it has to be installed automatically and not committed to repository).</p>

<h2>Add environment configuration and Update Composer <a name="add-environment-config"></a></h2>

<p>The ElasticBeanstalk environment can be configured by using <code>.config</code> files inside <code>.ebextensions</code> directory. You can read more about how to <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html">customize EC2 intances in docs</a>. In short it reads the <code>.config</code> files from <code>.ebextensions</code> directory and runs them in alphabetical order. After the deployment <code>.ebextensions</code> directory is removed.</p>

<p>The composer by default used in environments has an old version, it&rsquo;s a good idea to have it updated. All of this can be done by creating <code>03-main.config</code> file and adding the following contents to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">300-composer-update</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;export</span><span class="nv"> </span><span class="s">COMPOSER_HOME=/root</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">composer.phar</span><span class="nv"> </span><span class="s">self-update</span><span class="nv"> </span><span class="s">-n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The config file starts with <code>03-</code> so we could have some breathing room if other configuration files have to be run before it. The commands are also run alphabetically so it&rsquo;s a good idea to start with a hundred based number as it will give you enough space for 99 commands before you will need to modify the order of them.</p>

<p>Now you could push your application to the environment (it still won&rsquo;t work as additional steps are required) by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git aws.push
</span></code></pre></td></tr></table></div></figure>


<h2>Install mongo extension <a name="install-mongo-extension"></a></h2>

<p>Our project uses the MongoDB and the required PHP mongo extension is not available by default on created environment. This can be easily taken care of by adding a command to install it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">200-install-mongo-ext</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;yes</span><span class="nv"> </span><span class="s">&#39;&#39;</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">pecl</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">mongo&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ignoreErrors</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>ignoreErrors</code> is required as it would be thrown if the extension is already installed. This way if extension is already installed, it just skips this step. If for some reason the extension failed to install, your deployment would still fail on composer install step as it won&rsquo;t have the required extension.</p>

<h2>Run Composer Install <a name="run-composer-install"></a></h2>

<p>The next step would be to run the composer install. This can be done by adding <code>container_command</code> which runs after the application and web server have been set up, but before the application version is deployed. Add the following to <code>03-main.config</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">300-run-composer</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;composer.phar</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">--no-dev</span><span class="nv"> </span><span class="s">--optimize-autoloader</span><span class="nv"> </span><span class="s">--prefer-dist</span><span class="nv"> </span><span class="s">--no-interaction&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will run composer install without <code>require-dev</code> packages (in production we don&rsquo;t need them), optimize the autoloader (performance improvements), preferring distribution packages (performance improvement) and without any interaction (as the deployment is being done automatically).</p>

<h2>Update Cache Files <a name="update-cache-files"></a></h2>

<p><strong>Important:</strong> If you&rsquo;re using at least <a href="http://symfony.com/blog/symfony-2-6-1-released">Symfony 2.6.1</a> this is not needed anymore as cache files are now relative.</p>

<p>Because all commands are being run while in <em>&ldquo;staging&rdquo;</em> area the locations are incorrect after deployment (<code>/var/app/ondeck</code> should be changed to <code>/var/app/current</code>). This can be fixed by running a <code>sed</code> command on cache files. Add the following to <code>03-main.config</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">600-update-cache</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;source</span><span class="nv"> </span><span class="s">.ebextensions/bin/update-cache.sh&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the file <code>.ebextensions/bin/update-cache.sh</code> with contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>i in <span class="k">$(</span>grep -l -R <span class="s2">&quot;ondeck&quot;</span> /var/app/ondeck/app/cache/<span class="nv">$SYMFONY_ENV</span>/*<span class="k">)</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span>sed -i -e <span class="s2">&quot;s/\/var\/app\/ondeck/\/var\/app\/current/g&quot;</span> <span class="nv">$i</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script will replace all <code>/var/app/ondeck</code> occurrences with <code>/var/app/current</code> in cache files.</p>

<p>If you pushed your application to an environment at this moment you should have a completely functioning application. Read the following sections to improve your deployment.</p>

<h2>Add Apache Configuration (optional) <a name="add-apache-config"></a></h2>

<p>The PHP values can be changed using Apache configuration. The Apache configuration can also be updated to improve the security of your application (e.g., disallow entering hidden directories or files). Add an Apache configuration file to <code>.ebextensions/apache/zapplication.conf</code> with following contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">php_value</span> short_open_tag <span class="k">off</span>
</span><span class='line'>
</span><span class='line'><span class="c"># &quot;-Indexes&quot; will have Apache block users from browsing folders without a</span>
</span><span class='line'><span class="c"># default document Usually you should leave this activated, because you</span>
</span><span class='line'><span class="c"># shouldn&#39;t allow everybody to surf through every folder on your server (which</span>
</span><span class='line'><span class="c"># includes rather private places like CMS system folders).</span>
</span><span class='line'><span class="nt">&lt;IfModule</span> <span class="s">mod_autoindex.c</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">Options</span> -Indexes
</span><span class='line'><span class="nt">&lt;/IfModule&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Block access to &quot;hidden&quot; directories or files whose names begin with a</span>
</span><span class='line'><span class="c"># period. This includes directories used by version control systems such as</span>
</span><span class='line'><span class="c"># Subversion or Git.</span>
</span><span class='line'><span class="nt">&lt;IfModule</span> <span class="s">mod_rewrite.c</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">RewriteCond</span> %{SCRIPT_FILENAME} -d [OR]
</span><span class='line'>  <span class="nb">RewriteCond</span> %{SCRIPT_FILENAME} -f
</span><span class='line'>  <span class="nb">RewriteRule</span> <span class="s2">&quot;(^|/)\.&quot;</span> - [F]
</span><span class='line'><span class="nt">&lt;/IfModule&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Block access to backup and source files. These files may be left by some</span>
</span><span class='line'><span class="c"># text/html editors and pose a great security danger, when anyone can access</span>
</span><span class='line'><span class="c"># them.</span>
</span><span class='line'><span class="nt">&lt;FilesMatch</span> <span class="s">&quot;(\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist|pem)|~)$&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">Order</span> allow,deny
</span><span class='line'>  <span class="nb">Deny</span> from <span class="k">all</span>
</span><span class='line'>  <span class="nb">Satisfy</span> <span class="k">All</span>
</span><span class='line'><span class="nt">&lt;/FilesMatch&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Block access to files &amp; directories starting with a dot</span>
</span><span class='line'><span class="nt">&lt;FilesMatch</span> <span class="s">&quot;^\.&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">Order</span> allow,deny
</span><span class='line'>  <span class="nb">Deny</span> from <span class="k">all</span>
</span><span class='line'><span class="nt">&lt;/FilesMatch&gt;</span>
</span><span class='line'><span class="nt">&lt;DirectoryMatch</span> <span class="s">&quot;^\.|\/\.&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">Order</span> allow,deny
</span><span class='line'>  <span class="nb">Deny</span> from <span class="k">all</span>
</span><span class='line'><span class="nt">&lt;/DirectoryMatch&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will change PHP <code>short_open_tag</code> value to <code>off</code> and make other changes to make your application more secure. The configuration file starts with letter <code>z</code> as we want to load this configuration at the end.</p>

<p>Add the container command to your <code>03-main.config</code> file to copy this configuration file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">200-copy-apache-config</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;cp</span><span class="nv"> </span><span class="s">.ebextensions/apache/zapplication.conf</span><span class="nv"> </span><span class="s">/etc/httpd/conf.d/zapplication.conf&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Remove dev Entry Point (optional) <a name="remove-dev-entry"></a></h2>

<p>As we are deploying to production, it doesn&rsquo;t make a lot of sense to keep development environment entry point (especially if you remove IP or similar checks). This entry point can be removed on deployment by adding following container command to <code>03-main.config</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">700-remove-dev-app</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;rm</span><span class="nv"> </span><span class="s">web/app_dev.php&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Add Cron (optional) <a name="add-cron"></a></h2>

<p>Your application might need to use the cron to run some tasks on schedule. Create a new file <code>.ebextensions/cron/main</code> and put your commands in it (just make sure this file ends with an empty line).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>*/5 * * * * . /opt/elasticbeanstalk/support/envvars <span class="o">&amp;&amp;</span> php /var/app/current/app/console acme:hello
</span></code></pre></td></tr></table></div></figure>


<p>This command will run every five minutes. Crontab runs in a minimal environment so we start with <code>. /opt/elasticbeanstalk/support/envvars</code> to make sure it has all the environment variables. After that we run the Symfony console command from our application using the environment which is set as the environment variable. Add as many commands as you need in this file.</p>

<p>Make changes to <code>03-main.config</code> to update crontab tasks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">800-run-cron</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;crontab</span><span class="nv"> </span><span class="s">.ebextensions/cron/main&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you decide you don&rsquo;t need to run cron tasks anymore, <strong>don&rsquo;t</strong> just delete the container command. Make sure you make this change incrementally, by first removing all the contents from <code>.ebextensions/cron/main</code> file (leave it empty or change the existing <code>800-run-cron</code> command to <code>crontab -r</code>) and deploying it to your ElasticBeanstalk environment. Only after it&rsquo;s done should you remove the container command and a file. If you just removed the container command, your existing instances will keep the commands in <code>crontab</code> from previous deployment.</p>

<h2>Add New Relic Configuration (optional) <a name="add-new-relic-config"></a></h2>

<p>In case you would like to add <a href="http://newrelic.com">New Relic</a> monitoring for your application, all the required configuration can be added to your deployment. Create a new file <code>02-newrelic.config</code> which will contain the following configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">newrelic-php5</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'>        <span class="l-Scalar-Plain">newrelic-sysmond</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'>    <span class="l-Scalar-Plain">rpm</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">newrelic</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://yum.newrelic.com/pub/newrelic/el5/x86_64/newrelic-repo-5-3.noarch.rpm</span>
</span><span class='line'><span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">300-install-newrelic</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;newrelic-install</span><span class="nv"> </span><span class="s">install&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">300-update-newrelic-ini</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;source</span><span class="nv"> </span><span class="s">.ebextensions/bin/update-newrelic-ini.sh&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">400-configure-newrelic-sysmond</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;nrsysmond-config</span><span class="nv"> </span><span class="s">--set</span><span class="nv"> </span><span class="s">license_key=$NEW_RELIC_LICENSE_KEY&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">430-start-sysmond</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;/etc/init.d/newrelic-sysmond</span><span class="nv"> </span><span class="s">start&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will install New Relic agent and system monitoring daemon and update configuration used by them.</p>

<p>To update the configuration used by the agent create a <code>.ebextensions/bin/update-newrelic-ini.sh</code> script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'>sed -i -e <span class="s1">&#39;s/newrelic.license.*/newrelic.license = &#39;</span><span class="s2">&quot;$NEW_RELIC_LICENSE_KEY&quot;</span><span class="s1">&#39;/&#39;</span> /etc/php-5.5.d/newrelic.ini
</span><span class='line'>sed -i -e <span class="s1">&#39;s/newrelic.appname.*/newrelic.appname = &quot;&#39;</span><span class="s2">&quot;$SYMFONY__ENV__NEW_RELIC__APPLICATION_NAME&quot;</span><span class="s1">&#39;&quot;/&#39;</span> /etc/php-5.5.d/newrelic.ini
</span></code></pre></td></tr></table></div></figure>


<p>The script will set the license and application name using values from environment variables. Add the new environment variables to <code>.ebextensions/env/prod-variables.json</code> file and update your environment using AWS CLI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="err">...</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__NEW_RELIC__API__KEY&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;SYMFONY__ENV__NEW_RELIC__APPLICATION_NAME&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:elasticbeanstalk:application:environment&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;OptionName&quot;</span><span class="p">:</span> <span class="s2">&quot;NEW_RELIC_LICENSE_KEY&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Install <a href="https://github.com/ekino/EkinoNewRelicBundle">EkinoNewRelicBundle</a> in your Symfony application by running the following on your development environment (don&rsquo;t forget to enable the bundle in your <code>app/AppKernel.php</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>composer require ekino/newrelic-bundle <span class="s2">&quot;1.2.*@dev&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the following to your configuration files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># in app/config/config.yml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">ekino_new_relic</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>    <span class="l-Scalar-Plain">application_name</span><span class="p-Indicator">:</span> <span class="s">&quot;%new_relic_application_name%&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">api_key</span><span class="p-Indicator">:</span> <span class="s">&quot;%new_relic_api_key%&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># in app/config/config_prod.yml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">ekino_new_relic</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update your <code>app/config/parameters.yml.dist</code> with new parameters:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">new_relic_application_name</span><span class="p-Indicator">:</span> <span class="s">&quot;%env.new_relic.application_name%&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">new_relic_api_key</span><span class="p-Indicator">:</span> <span class="s">&quot;%env.new_relic.api.key%&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To notify about deployment add a new container command to <code>03-main.config</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">container_commands</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">900-notify-deployment</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;php</span><span class="nv"> </span><span class="s">app/console</span><span class="nv"> </span><span class="s">newrelic:notify-deployment</span><span class="nv"> </span><span class="s">--user=eb&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Push the application to your environment and if everything was done correctly you should start seeing some stats in your New Relic account.</p>

<h2>Install nodejs With Front-End Tools (2014-10-03 <a name="install-nodejs"></a></h2>

<p>If you watched a <a href="https://www.youtube.com/watch?v=R7iN5SFglMo">Ryan Weaver &ndash; Cool like Frontend Developer</a> or a similar talk you might want to add some front end goodness to your project. For this you will need to install nodejs, Grunt, Bower. Below are the steps on how to do it.</p>

<p>Create <code>.ebextensions/bin/install-nodejs.sh</code> with the contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">hash_file</span><span class="o">=</span><span class="s2">&quot;/tmp/nodejshash&quot;</span>
</span><span class='line'>
</span><span class='line'>check_if_npm_packages_has_to_be_installed <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$hash_file</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span>check_if_same_hash
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">        return </span>0
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>check_if_same_hash <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">hash_new</span><span class="o">=</span><span class="s2">&quot;$(md5sum .ebextensions/bin/install-nodejs.sh 2&gt; /dev/null | cut -d &#39; &#39; -f 1)&quot;</span>
</span><span class='line'>    <span class="nv">hash_current</span><span class="o">=</span><span class="s2">&quot;$(cat &quot;</span><span class="nv">$hash_file</span><span class="s2">&quot; 2&gt; /dev/null | cut -d &#39; &#39; -f 1)&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="nv">$hash_new</span> <span class="o">==</span> <span class="nv">$hash_current</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        return </span>1
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">        return </span>0
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>install_node <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if </span><span class="nb">hash </span>nodejs 2&gt; /dev/null; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">echo</span> <span class="s1">&#39;nodejs install, add more processing if needed&#39;</span> &gt; /dev/null
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">        </span>curl -sL https://rpm.nodesource.com/setup | bash -
</span><span class='line'>        yum install -y nodejs-0.10.32
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>install_npm_packages <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    npm install -g bower
</span><span class='line'>    npm install -g grunt-cli
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>update_current_hash <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="nv">$hash_new</span> &gt; <span class="nv">$hash_file</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>install_node
</span><span class='line'>
</span><span class='line'><span class="k">if </span>check_if_npm_packages_has_to_be_installed; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>install_npm_packages
</span><span class='line'>    update_current_hash
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script will install nodejs if it&rsquo;s not installed. Then it will check if npm packages have to be installed (new added or this is the first run) and install them if needed. Bower and Grunt-cli will be installed globally.</p>

<p>Add a container command to <code>03-main.config</code> to run this install script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">container_commands:</span>
</span><span class='line'>    <span class="mi">100</span><span class="err">-install-nodejs:</span>
</span><span class='line'>        <span class="err">command:</span> <span class="s2">&quot;source .ebextensions/bin/install-nodejs.sh&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To install local npm packages, bower packages and run grunt production tasks add the following container commands (see <a href="https://github.com/ifdattic/symfony-app-deploy-to-aws-eb-article-code/commit/1a651a94c134a80eb9895b4eb5aee99d37ad5823">repository</a> for file contents):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">container_commands:</span>
</span><span class='line'>    <span class="mi">400</span><span class="err">-install-npm-packages:</span>
</span><span class='line'>        <span class="err">command:</span> <span class="s2">&quot;npm install&quot;</span>
</span><span class='line'>    <span class="mi">425</span><span class="err">-install-bower-packages:</span>
</span><span class='line'>        <span class="err">command:</span> <span class="s2">&quot;bower install --allow-root&quot;</span>
</span><span class='line'>    <span class="mi">450</span><span class="err">-run-grunt:</span>
</span><span class='line'>        <span class="err">command:</span> <span class="s2">&quot;grunt production&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion <a name="conclusion"></a></h2>

<p>This article might not had all the steps required for deploying your Symfony application to ElasticBeanstalk, but it should point you on the right way to deploying your application. If something was not informative enough or confusing, please let me know and I will try to clarify it. If you have any questions or ideas, leave them in the comments to start the knowledge sharing.</p>

<blockquote><p>I&rsquo;m doing research on this topic and would appreciate if you would like to fill some questions at <a href="http://goo.gl/forms/cmEu5sio7G" data-ga-event="eb,click,bottom" target="_blank">Google Forms</a>. It&rsquo;s fine if you don&rsquo;t want to answer any of them or only answer one, every bit helps. Thank you for your time and enjoy the article.</p></blockquote>
</div>


  <footer>
    <ul class="social-buttons">
  <li>
    <a class="socialite twitter-share"
      href="https://twitter.com/share"
      data-via="ifdattic"
      data-count="vertical"
      rel="nofollow"
      target="_blank">
      Share on Twitter
    </a>
  </li>
  <li>
    <a class="socialite twitter-follow"
      href="https://twitter.com/ifdattic"
      data-count="vertical"
      target="_blank">
      Follow me
    </a>
  </li>
  <li>
    <a class="socialite googleplus-one"
    href="https://plus.google.com/share"
    data-size="tall"
    rel="nofollow"
    target="_blank">
      Share on Google+
    </a>
  </li>
  <li>
    <a class="socialite facebook-like"
      href="https://www.facebook.com/sharer.php"
      data-layout="box_count"
      data-width="60"
      data-show-faces="false"
      rel="nofollow"
      target="_blank">
      Share on Facebook
    </a>
  </li>
  <li>
    <a class="socialite linkedin-share"
      href="https://www.linkedin.com/shareArticle"
      data-counter="top"
      rel="nofollow"
      target="_blank">
      Share on LinkedIn
    </a>
  </li>
</ul>

    <p class="meta">
      <a href="https://github.com/ifdattic/ifdattic.github.io/blob/source/source/_posts/2014-09-19-how-to-deploy-symfony-application-to-aws-elasticbeanstalk.markdown">Edit this page on GitHub</a><br />
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew MarcinkeviÄius</span></span>

      








  


<time datetime="2014-09-19T08:03:02+02:00" pubdate data-updated="true">September 19, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/categories/aws/'>AWS</a>, <a class='category' href='/categories/deploy/'>Deploy</a>, <a class='category' href='/categories/elasticbeanstalk/'>ElasticBeanstalk</a>, <a class='category' href='/categories/symfony/'>Symfony</a>, <a class='category' href='/categories/technical/'>Technical</a>, <a class='category' href='/categories/tips/'>Tips</a>
  
</span>


    </p>
    <p class="meta">
      
        <a class="basic-alignment left" href="/what-learning-to-swim-reminded-me-about-life" title="Previous Post: What learning to swim reminded me about life">&laquo; What learning to swim reminded me about life</a>
      
      
        <a class="basic-alignment right" href="/fighting-your-fears-triple-combo-flower-girl" title="Next Post: Fighting Your Fears: Triple Combo - Flower Girl">Fighting Your Fears: Triple Combo - Flower Girl &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <footer role="contentinfo"><div class="wrapper"><p>&copy; 2015 - Andrew MarcinkeviÄius</p>
<p>
  Hosted on <a href="https://github.com/ifdattic/ifdattic.github.io">Github</a>
  -
  Powered by <a href="http://octopress.org">Octopress</a>
</p>

</div></footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ifdattic';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ifdattic.com/how-to-deploy-symfony-application-to-aws-elasticbeanstalk';
        var disqus_url = 'http://ifdattic.com/how-to-deploy-symfony-application-to-aws-elasticbeanstalk';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


<script src="/javascripts/socialite.min.js"></script>
<script src="/javascripts/scripts.js" type="text/javascript"></script>


</body>
</html>
